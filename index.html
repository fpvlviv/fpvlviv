<html>
<head>
	<script>
		const withEscSensors = {
			crabonXing880: true,
			crabonBH900: false,
			fgBat800: false,
			fgBat900: true,
			fgEmax730: true
		};

		const vtxTables = {
			raceRanger: 'akk race ranger.txt',
			dominator: 'akk dominator.txt',
			maxsolo: 'rushfpv max solo.txt'
		};

		const pids = {
			crabonXing880: 'carbon Xing880.txt',
			crabonBH900: 'crabon BrotherHobby900.txt',
			fgBat800: 'fiberglass Bat800.txt',
			fgBat900: 'fiberglass Bat900.txt',
			fgEmax730: 'fiberglass Emax730.txt'
		};

		const names = {
			crabonXing880: 'Gurkit',
			crabonBH900: 'Gurkit',
			fgBat800: 'La Bdzhola',
			fgBat900: 'La Bdzhola',
			fgEmax730: 'La Bdzhola'
		};

		async function runGenProfile() {
			const pidOpt = document.getElementById('pid').value;
			const vtxOpt = document.getElementById('vtx').value;
			
			const pidOptName = document.getElementById('pid').options[document.getElementById('pid').selectedIndex].text;
			const vtxOptName = document.getElementById('vtx').options[document.getElementById('vtx').selectedIndex].text;
			
			const profileContents = genProfile(
				names[pidOpt], 
				withEscSensors[pidOpt], 
				await getContent('./data/vtx/' + encodeURIComponent(vtxTables[vtxOpt])),
				await getContent('./data/pid/' + encodeURIComponent(pids[pidOpt]))
			);
			
			var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([profileContents], { type: 'text/plain' }));
            a.download = (names[pidOpt] + '_sb405v3_btf443_10frame_' + pidOptName + '_' + vtxOptName)
				.replaceAll(',','')
				.replaceAll(' ', '_') + '.txt';

            // Append the anchor to the body (required for Firefox)
            document.body.appendChild(a);
            // Programmatically click the anchor to trigger the download
            a.click();
            // Remove the anchor from the body
            document.body.removeChild(a);
			URL.revokeObjectURL(a.href);
		}

		function genProfile(name, withEscSensor, vtxTable, pidSettings) {
			return evaluateTemplate(profileTemplate, {name, withEscSensor, vtxTable, pidSettings});
		}
		
		function evaluateTemplate(template, data) {
	        for (const [key, value] of Object.entries(data)) {
	            this[key] = value;
	        }
		    return new Function("return `" + template + "`;").call();
		}
		
		async function getContent(url) {
	        const response = await fetch(url);
	        if (!response.ok) {
	            throw new Error(`Error: ${response.status}`);
	        }
			const x = await response.text();
	        return x;
		}
		
		getContent("./data/template.txt").then(result => window.profileTemplate = result);
	</script>
</head>
<body>
	<div>
		Налаштування PID
		<select id="pid">
			<option value="crabonXing880">Carbon, Xing 2814 880KV</option>
			<option value="crabonBH900">Carbon, BrotherHobby AvengerV3 2812 900KV</option>
			<option value="fgBat800">Fiberglass, Bat 3110 800KV</option>
			<option value="fgBat900">Fiberglass, Bat 3115 900KV</option>
			<option value="fgEmax730">Fiberglass, Emax 2814 730KV</option>
		</select>
	</div>
	<div>
		Відеопередавач
		<select id="vtx">
			<option value="dominator">AKK Dominator</option>
			<option value="raceRanger">AKK Race Ranger</option>
			<option value="maxsolo">RushFPV Max Solo</option>
		</select>
	</div>
	<button onclick="runGenProfile()">Скачати профіль</button>
</body>
</html>
